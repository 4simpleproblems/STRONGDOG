<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - STRONGDOG</title>
    <link rel="icon" type="image/x-icon" href="../img/favicon.ico" />

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="../firebase-config.js"></script>

    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>

    <style>
        /* This rule hides the body by default. The auth gate script will make it visible. */
        body {
            visibility: hidden;
        }

        @font-face {
            font-family: 'primary';
            src: url('../fonts/primary.woff') format('woff');
        }

        :root {
            --red: rgb(220, 53, 69);
            --green: rgb(40, 167, 69);
            --ff: 'primary', Arial, sans-serif;
            --bg: #2e2e2e;
        }

        body {
            font-family: var(--ff);
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: white;
            overflow-x: hidden;
        }

        .navbar {
            background-color: rgba(50, 50, 50, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 2.5rem;
            letter-spacing: 1px;
            transition: transform 0.3s ease;
            text-decoration: none;
            color: white;
        }

        .logo:hover {
            transform: translateX(-50%) scale(1.025);
        }

        .logo .xp {
            color: orange;
            text-shadow: 0 0 10px rgba(255, 165, 0, 0.5);
        }

        .menu-icon {
            font-size: 2.5rem;
            cursor: pointer;
            color: white;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .menu-icon:hover {
            transform: scale(1.2);
        }

        .slide-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 400px;
            backdrop-filter: blur(10px);
            color: white;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.7);
            z-index: 1003;
            transition: transform 0.5s ease;
            transform: translateX(-100%);
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background: linear-gradient(to bottom right,
                    rgba(43, 43, 43, 0.599),
                    rgba(53, 53, 53, 0.599),
                    rgba(80, 80, 80, 0.599));
        }

        .slide-menu::-webkit-scrollbar {
            display: none;
        }

        .categories {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-top: 20px;
        }

        .categories>a,
        .categories>button {
            padding: 17px;
            background: linear-gradient(45deg, #333, #444);
            border-radius: 15px;
            text-decoration: none;
            color: white;
            transition: transform 0.4s ease, background 0.4s ease, box-shadow 0.4s ease;
            text-align: center;
            font-size: 1.2rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
            font-family: var(--ff);
        }

        .categories>a:hover,
        .categories>button:hover {
            background: linear-gradient(45deg, #ffa500, #ff8433);
            box-shadow: 0 6px 20px rgba(255, 98, 0, 0.5);
        }

        .main-content {
            padding: 20px;
        }

        h2 {
            text-align: center;
            color: white;
            margin: 40px 0;
            font-size: 2.5rem;
            text-shadow: none;
        }

        .info-message {
            color: #ddd;
            text-align: center;
            max-width: 700px;
            margin: 0 auto 40px auto;
            padding: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            background-color: #3f3f3f;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .saves-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .save-slot {
            background: #444444;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            padding: 25px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            border-left: 5px solid #666;
        }

        .save-slot:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border-left-color: orange;
        }

        .save-title {
            font-size: 1.5em;
            margin-bottom: 10px;
            text-align: left;
            color: #ffc107;
        }

        .save-description {
            font-size: 1em;
            text-align: left;
            color: #ccc;
        }

        .delete-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #a83632;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            line-height: 35px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .delete-button:hover {
            background: #f00;
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #4a4a4a;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            color: white;
            position: relative;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
        }

        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            z-index: 3000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-text {
            font-size: 1.5rem;
            margin-top: 20px;
        }

        .loading-animation {
            border: 8px solid #f3f3f3;
            border-top: 8px solid orange;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .bottom-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-top: 40px;
            padding-bottom: 40px;
        }

        .save-action-btn {
            background: linear-gradient(45deg, #ffa500, #ff8433);
            color: white;
            font-family: var(--ff);
            font-size: 1.2rem;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 350px;
            max-width: 90%;
        }

        .save-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 98, 0, 0.5);
            filter: brightness(1.1);
        }

        #credits-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding-top: 15vh;
        }

        #credits-popup {
            background: #3a3a3a;
            color: white;
            padding: 25px 35px;
            border-radius: 15px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            position: relative;
            border: 1px solid #555;
        }

        #close-credits-popup {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2.5rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        #close-credits-popup:hover {
            color: white;
            transform: scale(1.1);
        }

        #credits-popup h3 {
            text-align: center;
            font-size: 2rem;
            margin-top: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid orange;
            padding-bottom: 10px;
        }

        #credits-popup .credit-person {
            margin-bottom: 20px;
        }

        #credits-popup .credit-person h4 {
            font-size: 1.4rem;
            color: orange;
            margin: 0 0 8px 0;
        }

        #credits-popup .credit-person p {
            font-size: 1rem;
            line-height: 1.5;
            margin: 0;
            color: #e0e0e0;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="menu-icon" id="menuIcon">☰</div>
        <a href="../index.html" class="logo">strongdog<span class="xp">XP</span></a>
        <div class="search-container">
            <input type="text" class="search-bar" placeholder="Search is disabled here" id="searchInput" autocomplete="off" disabled />
        </div>
    </div>
    <div class="slide-menu" id="slideMenu">
        <div class="categories" id="sidebarCategories">
            <a href="https://4simpleproblems.github.io/logged-in/games.html" class="option-link">Back to 4SP</a>
            <a href="../index.html" class="option-link">Back to StrongdogXP</a>
            <a href="#" id="blockLanschool" class="option-link">Open in about:blank</a>
            <a href="https://discord.gg/dyyebUaqRS" class="option-link">Discord Server</a>
            <a href="#" id="creditsBtn" class="option-link">Credits</a>
        </div>
    </div>
    <div class="main-content">
        <h2>Local Save Manager</h2>
        <p class="info-message">
            Welcome to your Local Save Manager! This tool lets you back up your progress directly in your browser.
            You can save your current data into one of three slots, load it back later, or transfer it using a file.
        </p>
        <div class="saves-container" id="savesContainer"></div>
        <div class="bottom-buttons" id="bottomButtonsContainer"></div>
    </div>
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div id="credits-overlay">
        <div id="credits-popup">
            <span id="close-credits-popup">&times;</span>
            <h3>Credits</h3>
            <div class="credit-person">
                <h4>John P - Creator of StrongdogXP</h4>
                <p>He downloaded, compiled and created Strongdog entirely.</p>
            </div>
            <div class="credit-person">
                <h4>4SP</h4>
                <p>Converted file directories to work with the website, fixed many bugs, and polished up the design.</p>
            </div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation"></div>
        <p id="loadingText" class="loading-text">Loading...</p>
    </div>

    <script type="module">
        import {
            siteMapping
        } from "../site-mapping.js";

        const savesContainer = document.getElementById("savesContainer");
        const bottomButtonsContainer = document.getElementById("bottomButtonsContainer");
        const modal = document.getElementById("modalPrompt");
        const modalClose = document.getElementById("modalClose");
        const modalText = document.getElementById("modalText");
        const modalButtons = document.getElementById("modalButtons");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");
        let loadingTimeout = null;

        function getCurrentSiteKey() {
            const currentURL = window.location.href;
            const keys = Object.keys(siteMapping);
            keys.sort((a, b) => b.length - a.length);
            for (const key of keys) {
                const normalizedKey = key.replace(/^https?:\/\//, "");
                if (currentURL.includes(normalizedKey)) {
                    return normalizedKey;
                }
            }
            return window.location.host + window.location.pathname.replace(/\/$/, "");
        }
        const currentDomainKey = getCurrentSiteKey();

        function openModal(text, buttons = []) {
            modalText.textContent = text;
            modalButtons.innerHTML = "";
            buttons.forEach(btn => {
                const buttonEl = document.createElement("button");
                buttonEl.className = "save-action-btn";
                buttonEl.style.width = 'auto';
                buttonEl.style.fontSize = '1rem';
                buttonEl.textContent = btn.text;
                buttonEl.onclick = btn.onclick;
                modalButtons.appendChild(buttonEl);
            });
            modal.style.display = "flex";
        }
        modalClose.addEventListener("click", () => {
            modal.style.display = "none";
        });
        window.addEventListener("click", event => {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        });

        function showLoading(text = "Loading...") {
            loadingText.textContent = text;
            loadingOverlay.style.display = "flex";
            loadingOverlay.classList.add("active");
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
            }, 5000);
        }

        function hideLoading() {
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            loadingOverlay.classList.remove("active");
            loadingOverlay.style.display = "none";
        }

        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key.startsWith('sdxp_save_slot_')) {
                    const value = localStorage.getItem(key);
                    data[key] = value;
                }
            }
            return data;
        }

        function setAllLocalStorageData(data) {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key.startsWith('sdxp_save_slot_')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));

            for (const [key, value] of Object.entries(data)) {
                localStorage.setItem(key, value);
            }
        }

        async function getAllIndexedDBData() {
            if (!('indexedDB' in window) || !indexedDB.databases) return {};
            let dbList = [];
            try {
                dbList = await indexedDB.databases();
            } catch (error) {
                console.error("Error fetching IndexedDB databases:", error);
                return {};
            }

            const result = {};
            for (const dbInfo of dbList) {
                if (!dbInfo.name) continue;
                result[dbInfo.name] = await getDataFromDatabase(dbInfo.name);
            }
            return result;
        }

        function getDataFromDatabase(dbName) {
            return new Promise((resolve, reject) => {
                try {
                    const request = indexedDB.open(dbName);
                    request.onsuccess = event => {
                        const db = event.target.result;
                        const storeNames = Array.from(db.objectStoreNames);
                        const dbData = {};
                        if (storeNames.length === 0) {
                            db.close();
                            resolve(dbData);
                            return;
                        }
                        const transaction = db.transaction(storeNames, "readonly");
                        let storesCompleted = 0;
                        storeNames.forEach(storeName => {
                            const store = transaction.objectStore(storeName);
                            const items = [];
                            const cursorRequest = store.openCursor();
                            cursorRequest.onsuccess = evt => {
                                const cursor = evt.target.result;
                                if (cursor) {
                                    items.push({
                                        key: cursor.key,
                                        value: cursor.value
                                    });
                                    cursor.continue();
                                } else {
                                    dbData[storeName] = items;
                                    storesCompleted++;
                                    if (storesCompleted === storeNames.length) {
                                        db.close();
                                        resolve(dbData);
                                    }
                                }
                            };
                            cursorRequest.onerror = evt => {
                                console.error(`Error reading from ${storeName}:`, evt.target.error);
                                storesCompleted++;
                                if (storesCompleted === storeNames.length) {
                                    db.close();
                                    resolve(dbData);
                                }
                            };
                        });
                    };
                    request.onerror = event => reject(event.target.error);
                } catch (e) {
                    reject(e);
                }
            });
        }

        async function setAllIndexedDBData(allDbsData) {
            for (const dbName in allDbsData) {
                await new Promise(resolve => {
                    const deleteRequest = indexedDB.deleteDatabase(dbName);
                    deleteRequest.onsuccess = deleteRequest.onerror = deleteRequest.onblocked = () => resolve();
                });

                await new Promise((resolveDb, rejectDb) => {
                    const openRequest = indexedDB.open(dbName);
                    openRequest.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const storesData = allDbsData[dbName];
                        for (const storeName in storesData) {
                            if (!db.objectStoreNames.contains(storeName)) {
                                db.createObjectStore(storeName);
                            }
                        }
                    };
                    openRequest.onsuccess = async (event) => {
                        const db = event.target.result;
                        const storesData = allDbsData[dbName];
                        const tx = db.transaction(Object.keys(storesData), 'readwrite');
                        for (const storeName in storesData) {
                            const store = tx.objectStore(storeName);
                            for (const record of storesData[storeName]) {
                                store.put(record.value, record.key);
                            }
                        }
                        tx.oncomplete = () => {
                            db.close();
                            resolveDb();
                        };
                        tx.onerror = (e) => {
                            console.error(e);
                            db.close();
                            resolveDb();
                        };
                    };
                    openRequest.onerror = (event) => rejectDb(event.target.error);
                });
            }
        }

        function normalizeDomainKey(str) {
            return str.replace(/^https?:\/\//, "").replace(/\/$/, "");
        }

        function replaceDomainsInData(dataObj, currentDomain) {
            if (!dataObj || typeof dataObj !== 'object') return;
            const keysToCheck = Object.keys(siteMapping).map(k => normalizeDomainKey(k));
            const normalizedCurrentDomain = normalizeDomainKey(currentDomain);

            function replaceInString(str) {
                for (const oldDomain of keysToCheck) {
                    if (str.includes(oldDomain)) {
                        return str.replace(new RegExp(oldDomain, 'g'), normalizedCurrentDomain);
                    }
                }
                return str;
            }

            if (dataObj.localStorageBackup) {
                const lsData = dataObj.localStorageBackup;
                for (const k in lsData) {
                    const newKey = replaceInString(k);
                    let newVal = lsData[k];
                    if (typeof newVal === "string") newVal = replaceInString(newVal);
                    if (newKey !== k) {
                        delete lsData[k];
                        lsData[newKey] = newVal;
                    } else {
                        lsData[k] = newVal;
                    }
                }
            }
        }

        async function handleLoadSave(slotKey) {
            showLoading("Loading save from slot...");
            try {
                const savedDataJSON = localStorage.getItem(slotKey);
                if (savedDataJSON) {
                    const parsedData = JSON.parse(savedDataJSON);
                    replaceDomainsInData(parsedData.data, currentDomainKey);

                    if (parsedData.data.localStorageBackup) {
                        setAllLocalStorageData(parsedData.data.localStorageBackup);
                    }
                    if (parsedData.data.indexedDBBackup) {
                        await setAllIndexedDBData(parsedData.data.indexedDBBackup);
                    }
                    alert("Load complete!");
                }
            } catch (e) {
                console.error(e);
                alert("Error loading save!");
            } finally {
                hideLoading();
            }
        }

        function renderLocalSlots() {
            savesContainer.innerHTML = "";
            for (let i = 1; i <= 3; i++) {
                const slotKey = `sdxp_save_slot_${i}`;
                const slotDataJSON = localStorage.getItem(slotKey);
                const slotData = slotDataJSON ? JSON.parse(slotDataJSON) : null;

                const slotEl = document.createElement("div");
                slotEl.className = "save-slot";

                let titleText = `Slot ${i} - Empty`;
                let descText = "Click here to save your current game progress";

                if (slotData) {
                    titleText = slotData.title;
                    descText = slotData.description;
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-button";
                    deleteBtn.textContent = "×";
                    deleteBtn.onclick = e => {
                        e.stopPropagation();
                        openModal(`Are you sure you want to delete '${titleText}'? This action is irreversible.`, [{
                                text: "Yes, Delete",
                                onclick: () => {
                                    modal.style.display = 'none';
                                    localStorage.removeItem(slotKey);
                                    renderLocalSlots();
                                }
                            },
                            {
                                text: "No",
                                onclick: () => modal.style.display = 'none'
                            }
                        ]);
                    };
                    slotEl.appendChild(deleteBtn);
                }

                const titleEl = document.createElement("div");
                titleEl.className = "save-title";
                titleEl.textContent = titleText;
                const descEl = document.createElement("div");
                descEl.className = "save-description";
                descEl.textContent = descText;
                slotEl.appendChild(titleEl);
                slotEl.appendChild(descEl);

                slotEl.addEventListener("click", async () => {
                    if (!slotData) {
                        const titlePrompt = prompt(`Enter a title for Slot ${i}:`, "");
                        if (!titlePrompt) return;
                        const descPrompt = prompt("Enter a description:", `Saved on ${new Date().toLocaleString()}`);
                        if (descPrompt === null) return;

                        showLoading("Saving data to local slot...");
                        const localData = {
                            localStorageBackup: getAllLocalStorageData(),
                            indexedDBBackup: await getAllIndexedDBData(),
                        };
                        const dataToStore = {
                            title: titlePrompt,
                            description: descPrompt,
                            data: localData
                        };
                        localStorage.setItem(slotKey, JSON.stringify(dataToStore));
                        hideLoading();
                        alert("Save complete!");
                        renderLocalSlots();
                    } else {
                        openModal(`Actions for '${slotData.title}'`, [{
                                text: "Load Save",
                                onclick: () => {
                                    modal.style.display = "none";
                                    openModal("Loading this save will overwrite your current unsaved progress. Proceed?", [{
                                            text: "Yes, Load",
                                            onclick: async () => {
                                                modal.style.display = 'none';
                                                await handleLoadSave(slotKey);
                                            }
                                        },
                                        {
                                            text: "No",
                                            onclick: () => modal.style.display = 'none'
                                        }
                                    ]);
                                }
                            },
                            {
                                text: "Overwrite Save",
                                onclick: async () => {
                                    modal.style.display = "none";
                                    showLoading("Overwriting save...");
                                    const localData = {
                                        localStorageBackup: getAllLocalStorageData(),
                                        indexedDBBackup: await getAllIndexedDBData()
                                    };
                                    const dataToStore = {
                                        title: slotData.title,
                                        description: `Overwritten on ${new Date().toLocaleString()}`,
                                        data: localData
                                    };
                                    localStorage.setItem(slotKey, JSON.stringify(dataToStore));
                                    hideLoading();
                                    alert("Overwrite complete!");
                                    renderLocalSlots();
                                }
                            }
                        ]);
                    }
                });
                savesContainer.appendChild(slotEl);
            }
        }

        async function downloadAllSaves() {
            showLoading("Preparing download...");
            const localData = getAllLocalStorageData();
            const indexedData = await getAllIndexedDBData();
            const dataToDownload = {
                localStorageBackup: localData,
                indexedDBBackup: indexedData
            };
            hideLoading();
            const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], {
                type: "application/json"
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "strongdog_local_save.json";
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        }

        function handleFileUpload() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".json";
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async evt => {
                    let parsed;
                    try {
                        parsed = JSON.parse(evt.target.result);
                    } catch (err) {
                        alert("Invalid JSON file.");
                        return;
                    }

                    replaceDomainsInData(parsed, currentDomainKey);

                    openModal("Uploading this save file will overwrite all current game data. Are you sure?", [{
                            text: "Yes, Upload",
                            onclick: async () => {
                                modal.style.display = 'none';
                                showLoading("Uploading save...");
                                if (parsed.localStorageBackup) setAllLocalStorageData(parsed.localStorageBackup);
                                if (parsed.indexedDBBackup) await setAllIndexedDBData(parsed.indexedDBBackup);
                                hideLoading();
                                alert("Upload complete! The page will now reload to apply all changes.");
                                window.location.reload();
                            }
                        },
                        {
                            text: "No",
                            onclick: () => modal.style.display = 'none'
                        }
                    ]);
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function initializePage() {
            bottomButtonsContainer.innerHTML = ''; // Clear first
            const downloadButton = document.createElement("button");
            downloadButton.className = "save-action-btn";
            downloadButton.textContent = "Download Current Data to File";
            downloadButton.addEventListener("click", downloadAllSaves);

            const uploadButton = document.createElement("button");
            uploadButton.className = "save-action-btn";
            uploadButton.textContent = "Upload and Replace Data from File";
            uploadButton.addEventListener("click", handleFileUpload);

            bottomButtonsContainer.appendChild(downloadButton);
            bottomButtonsContainer.appendChild(uploadButton);

            renderLocalSlots();
        }

        // Initial Page Load
        initializePage();
    </script>

    <script>
        // --- Static Sidebar and Popup Functionality ---
        document.addEventListener('DOMContentLoaded', () => {
            const menuIcon = document.getElementById("menuIcon");
            const slideMenu = document.getElementById("slideMenu");

            menuIcon.addEventListener("click", e => {
                e.stopPropagation();
                slideMenu.style.transform = (slideMenu.style.transform === "translateX(0%)") ? "translateX(-100%)" : "translateX(0%)";
            });

            window.addEventListener("click", e => {
                if (e.target !== menuIcon && !slideMenu.contains(e.target)) {
                    slideMenu.style.transform = "translateX(-100%)";
                }
            });

            const blockLanschoolLink = document.getElementById("blockLanschool");
            blockLanschoolLink?.addEventListener("click", ev => {
                ev.preventDefault();
                const url = window.location.href;
                const newTab = window.open();
                if (!newTab) return alert("Please allow popups for this feature to work.");
                newTab.document.write(`<html><body style="margin:0;height:100vh;"><iframe src="${url}" style="border:none;width:100%;height:100%"></iframe></body></html>`);
                newTab.document.close();
            });

            const creditsBtn = document.getElementById('creditsBtn');
            const creditsOverlay = document.getElementById('credits-overlay');
            const closeCreditsPopup = document.getElementById('close-credits-popup');

            if (creditsBtn) {
                creditsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    slideMenu.style.transform = 'translateX(-100%)';
                    if (creditsOverlay) creditsOverlay.style.display = 'flex';
                });
            }
            if (closeCreditsPopup) {
                closeCreditsPopup.addEventListener('click', () => creditsOverlay.style.display = 'none');
            }
            if (creditsOverlay) {
                creditsOverlay.addEventListener('click', (e) => {
                    if (e.target === creditsOverlay) creditsOverlay.style.display = 'none';
                });
            }
        });
    </script>

    <script>
        /**
         * Authentication Gate (v4.5 - Foolproof Stacking Context Fix)
         * This script protects the page and correctly handles the ban screen overlay.
         */

        // --- 1. Immediately create a SIMPLE, invisible shield. ---
        (function() {
            if (document.getElementById('auth-shield-temporary')) return;

            const shield = document.createElement('div');
            shield.id = 'auth-shield-temporary';
            Object.assign(shield.style, {
                position: 'fixed',
                top: '0',
                left: '0',
                width: '100vw',
                height: '100vh',
                zIndex: '2147483647',
                backgroundColor: 'transparent'
            });

            document.documentElement.appendChild(shield);
            console.log("Debug: Temporary auth shield deployed.");
        })();

        /**
         * Helper function to remove the temporary shield and restore scrolling.
         */
        function removeTemporaryAuthShield() {
            const shield = document.getElementById('auth-shield-temporary');
            if (shield) {
                shield.remove();
            }
            // We only unlock scrolling if a ban screen isn't being shown
            if (!document.getElementById('ban-enforcer-container')) {
                document.documentElement.style.overflow = '';
                document.body.style.overflow = '';
            }
            console.log("Debug: Temporary auth shield removed.");
        }

        // --- 2. Wait for DOM to be ready, then lock scroll and check auth ---
        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            console.log("Debug: DOMContentLoaded fired. Page scrolling locked.");

            if (typeof firebase === 'undefined' || typeof firebase.auth === 'undefined' || typeof firebase.firestore === 'undefined') {
                console.error("FATAL ERROR: Firebase is not loaded correctly. Check script order in HTML.");
                document.body.innerHTML = `<h1 style="font-family: Arial, sans-serif; color: white; text-align: center; margin-top: 40px;">Fatal Error: Page cannot be loaded.</h1>`;
                document.body.style.visibility = 'visible';
                removeTemporaryAuthShield();
                return;
            }

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    const db = firebase.firestore();
                    const banDocRef = db.collection('bans').doc(user.uid);

                    banDocRef.get().then(doc => {
                        removeTemporaryAuthShield(); // Remove the simple shield in all logged-in cases
                        if (doc.exists) {
                            const banData = doc.data();
                            console.warn(`User ${user.uid} is BANNED. Activating permanent ban screen.`);
                            showBanScreen(banData); // Build the permanent, visible ban screen
                        } else {
                            console.log("Debug: User is logged in and not banned. Granting access.");
                            document.documentElement.style.overflow = '';
                            document.body.style.overflow = '';
                            document.body.style.visibility = 'visible'; // Make the main page content visible
                        }
                    }).catch(error => {
                        console.error("Debug: An error occurred while checking ban status. Granting access as a failsafe.", error);
                        removeTemporaryAuthShield();
                        document.body.style.visibility = 'visible';
                    });

                } else {
                    console.log("Debug: No user is logged in. Redirecting to login page.");
                    window.location.href = 'https://4simpleproblems.github.io/login.html';
                }
            });
        });

        /**
         * Creates the permanent, multi-layer ban screen and starts the persistence guard.
         */
        function showBanScreen(banData) {
            const banContainerId = 'ban-enforcer-container';

            const enforceBanVisuals = () => {
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';

                if (!document.getElementById(banContainerId)) {
                    console.warn("[Guard] Ban container not found. Rebuilding UI.");

                    document.body.style.visibility = 'visible'; // Make body visible for the ban screen to be appended to.

                    const banContainer = document.createElement('div');
                    banContainer.id = banContainerId;
                    Object.assign(banContainer.style, {
                        position: 'fixed',
                        top: '0',
                        left: '0',
                        width: '100vw',
                        height: '100vh',
                        zIndex: '2147483647'
                    });

                    const shield = document.createElement('div');
                    Object.assign(shield.style, {
                        position: 'absolute',
                        top: '0',
                        left: '0',
                        width: '100%',
                        height: '100%',
                        backgroundColor: 'rgba(10, 10, 10, 0.75)',
                        backdropFilter: 'blur(14px)',
                        webkitBackdropFilter: 'blur(14px)'
                    });
                    banContainer.appendChild(shield);

                    const homeButton = document.createElement('a');
                    homeButton.href = '../index.html';
                    homeButton.innerHTML = `<i class="fa-solid fa-house"></i>`;
                    Object.assign(homeButton.style, {
                        position: 'absolute',
                        top: '20px',
                        right: '20px',
                        width: '45px',
                        height: '45px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '22px',
                        color: 'white',
                        textDecoration: 'none',
                        backgroundColor: 'rgba(255, 255, 255, 0.15)',
                        borderRadius: '10px',
                        border: '1px solid rgba(255, 255, 255, 0.2)',
                        transition: 'background-color 0.3s ease'
                    });
                    homeButton.onmouseover = () => {
                        homeButton.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                    };
                    homeButton.onmouseout = () => {
                        homeButton.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
                    };
                    banContainer.appendChild(homeButton);

                    const reason = banData.reason ? String(banData.reason).replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'No reason provided.';
                    const banDate = banData.bannedAt && banData.bannedAt.toDate ? `on ${new Date(banData.bannedAt.seconds * 1000).toLocaleDateString()}` : '';
                    const messageBox = document.createElement('div');
                    messageBox.innerHTML = `
                        <h1 style="font-size: 2.3em; color: #fc0324; margin: 0 0 10px 0; font-weight: bold;">Access Denied</h1>
                        <p style="font-size: 1.1em; margin: 0 0 15px 0; line-height: 1.4; color: #e0e0e0;">Your account has been suspended from this service.</p>
                        <p style="font-size: 1em; margin: 0 0 20px 0; color: #bdbdbd;"><strong>Reason:</strong> ${reason}</p>
                        <p style="font-size: 0.8em; color: #9e9e9e;">This action was taken ${banDate}. If you believe this is an error, please contact 4simpleproblems+support@gmail.com</p>
                    `;
                    Object.assign(messageBox.style, {
                        position: 'absolute',
                        top: '40px',
                        left: '40px',
                        maxWidth: '600px',
                        width: 'auto',
                        textAlign: 'left',
                        color: '#ffffff',
                        fontFamily: "'PrimaryFont', Arial, sans-serif",
                        textShadow: '0 2px 8px rgba(0,0,0,0.7)'
                    });
                    banContainer.appendChild(messageBox);
                    document.body.appendChild(banContainer);
                }
            };

            if (!document.querySelector('link[href*="font-awesome"]')) {
                const faLink = document.createElement('link');
                faLink.rel = 'stylesheet';
                faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css';
                document.head.appendChild(faLink);
            }

            enforceBanVisuals();
            setInterval(enforceBanVisuals, 100);
        }
    </script>
</body>

</html>
